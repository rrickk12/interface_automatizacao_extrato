
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Relat√≥rio de Transa√ß√µes</title>
  <style>
  body {
    font-family: 'Segoe UI', sans-serif;
    margin: 20px;
    background-color: #f5f6fa;
    font-size: 14px;
    color: #2f3640;
  }
  
  h1 {
    text-align: center;
    color: #353b48;
    margin-bottom: 30px;
  }
  
  button, select, input {
    font-size: 14px;
    padding: 6px 10px;
    border-radius: 4px;
    border: 1px solid #ccc;
    transition: 0.3s;
  }
  
  button:hover {
    background-color: #dcdde1;
    cursor: pointer;
  }
  
  table {
    width: 100%;
    border-collapse: collapse;
    background-color: white;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    margin-top: 20px;
  }
  
  th, td {
    padding: 10px;
    border: 1px solid #eee;
    text-align: left;
    word-wrap: break-word;
  }
  
  th {
    background-color: #f1f2f6;
    color: #2f3640;
  }
  
  tr:nth-child(even) {
    background-color: #f9f9f9;
  }
  
  tr:hover {
    background-color: #f0f0f0;
  }
  
  tr.auto-classificado td select {
    background-color: #ffeaa7;
  }
  
  .contato-alert {
    background-color: #ffcccc;
  }
  
  .aba {
    display: none;
    animation: fadeIn 0.3s ease-in-out;
  }
  
  .visible {
    display: block;
  }
  
  #export-btn {
    background-color: #44bd32;
    color: white;
    border: none;
    padding: 10px 20px;
    margin: 10px 0;
    font-weight: bold;
  }
  
  #export-btn:hover {
    background-color: #4cd137;
  }
  
  .status-btn {
    padding: 5px 10px;
    margin: 0 2px;
    border: none;
    font-size: 16px;
    cursor: pointer;
    border-radius: 4px;
  }
  
  .status-btn:hover {
    opacity: 0.8;
  }
  
  form#form-regra {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 10px;
    margin-top: 15px;
  }
  
  form#form-regra input,
  form#form-regra select {
    width: 100%;
    padding: 8px;
    border: 1px solid #ccc;
  }
  
  form#form-regra button {
    background-color: #0984e3;
    color: white;
    grid-column: span 2;
  }
  
  form#form-regra button:hover {
    background-color: #74b9ff;
  }
  
  button.aba-toggle {
    background-color: #dcdde1;
    border: none;
    padding: 10px 15px;
    margin: 5px;
    border-radius: 6px;
    font-weight: bold;
  }
  
  button.aba-toggle:hover {
    background-color: #b2bec3;
  }
  
  @keyframes fadeIn {
    from {opacity: 0;}
    to {opacity: 1;}
  }

  tr.pending {
    background-color: #fff9c4; /* amarelo claro */
  }

  tr.validated {
    background-color: #d4edda; /* verde suave */
  }

  tr.canceled {
    background-color: #f8d7da; /* vermelho rosado */
  }

</style>  
  <script>
    const configCategorias = {{ config_json | tojson | safe }};
    let regras = {{ regras_json | tojson | safe }};
  </script>
  <script>
    function abrirAba(qual) {
      document.getElementById('aba-transacoes').classList.remove('visible');
      document.getElementById('aba-regras').classList.remove('visible');
      document.getElementById('aba-' + qual).classList.add('visible');
    }

    function atualizarTipos(row) {
    const tipoTransacao = row.dataset.tipoTransacao;
    const tipoSelect = row.querySelector('select[name="categoria_tipo"]');
    tipoSelect.innerHTML = '<option value="">Selecione</option>';
    if (configCategorias.tipos_por_transacao[tipoTransacao]) {
      configCategorias.tipos_por_transacao[tipoTransacao].forEach(tipo => {
        tipoSelect.innerHTML += `<option value="${tipo}">${tipo}</option>`;
      });
    }
    row.querySelector('select[name="categoria_nome"]').innerHTML = '<option value="">Selecione</option>';
  }


  function atualizarCategorias(select) {
    const row = select.closest('tr');
    const categoriaSelect = row.querySelector('select[name="categoria_nome"]');
    const tipoSelecionado = select.value;

    categoriaSelect.innerHTML = '<option value="">Selecione</option>';

    const sugeridas = [];
    const outras = [];

    Object.entries(configCategorias.categorias_por_tipo).forEach(([categoria, tipos]) => {
      if (tipos.includes(tipoSelecionado)) {
        sugeridas.push(categoria);
      } else {
        outras.push(categoria);
      }
    });

    sugeridas.forEach(cat => {
      categoriaSelect.innerHTML += `<option value="${cat}">${cat}</option>`;
    });

    if (outras.length > 0) {
      categoriaSelect.innerHTML += '<option disabled>‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</option>';
    }

    outras.forEach(cat => {
      categoriaSelect.innerHTML += `<option value="${cat}">${cat}</option>`;
    });
  }

    function setStatus(btn, status) {
      const row = btn.closest('tr');
      row.className = status;
    }

    function exportToCSV() {
      let csv = 'Data,Descri√ß√£o,Valor,Tipo Transa√ß√£o,Documento,Contato,Tipo,Categoria,Status\n';
      document.querySelectorAll('#aba-transacoes tbody tr').forEach(row => {
        const cols = row.querySelectorAll('td');
        const tipo = row.querySelector('select[name="categoria_tipo"]').value || '';
        const categoria = row.querySelector('select[name="categoria_nome"]').value || '';
        const status = row.className || '';

        const values = [
          ...Array.from(cols).slice(0, 6).map(td => td.innerText.trim()),
          tipo,
          categoria,
          status
        ];
        csv += values.map(v => `"${v.replaceAll('"', '""')}` ).join(',') + '\n';
      });

      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.setAttribute('href', url);
      link.setAttribute('download', 'relatorio_transacoes.csv');
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    function aplicarRegras(row) {
      const desc = row.cells[1].innerText;
      const contato = row.cells[5].innerText;
      regras.forEach(regra => {
        let match = true;
        if (regra.descricao_contain) {
          match = regra.descricao_contain.every(p => desc.includes(p));
        }
        if (regra.descricao_regex && !(new RegExp(regra.descricao_regex).test(desc))) {
          match = false;
        }
        if (regra.contato_igual && regra.contato_igual !== contato) {
          match = false;
        }

        if (match) {
          row.querySelector('select[name="categoria_tipo"]').value = regra.tipo;
          atualizarCategorias(row.querySelector('select[name="categoria_tipo"]'));
          row.querySelector('select[name="categoria_nome"]').value = regra.categoria;
          row.classList.add('auto-classificado');
        }
      });
    }

    function adicionarRegra() {
      const form = document.getElementById("form-regra");
      const novaRegra = {
        descricao_contain: form.descricao_contain.value.split(',').map(v => v.trim()).filter(Boolean),
        descricao_regex: form.descricao_regex.value.trim() || null,
        contato_igual: form.contato_igual.value.trim() || null,
        tipo: form.tipo.value.trim(),
        categoria: form.categoria.value.trim()
      };
      regras.push(novaRegra);
      carregarRegras();
    }

    function carregarRegras() {
  const corpo = document.querySelector("#tabela-regras tbody");
  corpo.innerHTML = '';
  regras.forEach((regra, index) => {
    const linha = document.createElement('tr');
    linha.innerHTML = `
      <td>${(regra.descricao_contain || []).join(', ')}</td>
      <td>${regra.descricao_regex || ''}</td>
      <td>${regra.contato_igual || ''}</td>
      <td>${regra.tipo}</td>
      <td>${regra.categoria}</td>
      <td><button onclick="removerRegra(${index})">üóëÔ∏è</button></td>`;
    corpo.appendChild(linha);
  });

  document.querySelectorAll('#aba-transacoes tbody tr').forEach(row => aplicarRegras(row));
}

function removerRegra(index) {
  regras.splice(index, 1);
  carregarRegras();
}

    document.addEventListener('DOMContentLoaded', () => {
      abrirAba('transacoes');
      document.querySelectorAll('#aba-transacoes tbody tr').forEach(row => atualizarTipos(row));
      carregarRegras();
    });
  </script>
</head>
<body>
  <h1>Relat√≥rio de Transa√ß√µes</h1>

  <div>
    <button onclick="abrirAba('transacoes')">üìã Transa√ß√µes</button>
    <button onclick="abrirAba('regras')">üß† Regras</button>
  </div>

  <div id="aba-transacoes" class="aba">
    <button id="export-btn" onclick="exportToCSV()">üì§ Exportar CSV</button>
    <table>
      <thead>
        <tr>
          <th>Data</th>
          <th>Descri√ß√£o</th>
          <th>Valor</th>
          <th>Tipo Transa√ß√£o</th>
          <th>Documento</th>
          <th>Contato</th>
          <th>Tipo</th>
          <th>Categoria</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody>
        {% for item in data %}
        <tr class="pending" data-tipo-transacao="{{ item.transaction_type }}">
          <td>{{ item.get('date', '') }}</td>
          <td>{{ item.get('description', '') }}</td>
          <td>{{ item.get('amount', '') }}</td>
          <td>{{ item.get('transaction_type', '') }}</td>
          <td>{{ item.get('document', '') }}</td>
          <td class="{{ 'contato-alert' if not item.get('contato', {}).get('cpf_cnpj') else '' }}">
            {{ item.get('contato', {}).get('nome', '-') }}
          </td>
          <td>
            <select name="categoria_tipo" onchange="atualizarCategorias(this)">
              <option value="">Selecione</option>
              {% for tipo in tipos %}
                <option value="{{ tipo }}">{{ tipo }}</option>
              {% endfor %}
            </select>
            
          </td>
          <td>
            <select name="categoria_nome">
              <option value="">Selecione</option>
            </select>
          </td>
          <td>
            <button class="status-btn" onclick="setStatus(this, 'validated')">‚úÖ</button>
            <button class="status-btn" onclick="setStatus(this, 'canceled')">‚ùå</button>
          </td>
          
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div id="aba-regras" class="aba">
    <h2>Regras de Classifica√ß√£o</h2>
    <table id="tabela-regras">
      <thead>
        <tr><th>Descri√ß√£o Cont√©m</th><th>Regex</th><th>Contato</th><th>Tipo</th><th>Categoria</th><th></th></tr>
      </thead>
      <tbody></tbody>
    </table>
  
    <h3>‚ûï Nova Regra</h3>
    <form id="form-regra">
      <input name="descricao_contain" placeholder="Descri√ß√£o cont√©m (v√≠rgula separada)">
      <input name="descricao_regex" placeholder="Regex de descri√ß√£o">
      <input name="contato_igual" placeholder="Nome do contato exato">
      
      <select name="tipo">
        <option value="">Selecione o tipo</option>
        <script>
          configCategorias && Object.values(configCategorias.tipos_por_transacao).flat().filter((v, i, a) => a.indexOf(v) === i).forEach(t => {
            document.write(`<option value="${t}">${t}</option>`);
          });
        </script>
      </select>
  
      <select name="categoria">
        <option value="">Selecione a categoria</option>
        <script>
          configCategorias && Object.keys(configCategorias.categorias_por_tipo).forEach(c => {
            document.write(`<option value="${c}">${c}</option>`);
          });
        </script>
      </select>
  
      <button type="button" onclick="adicionarRegra()">Salvar regra</button>
    </form>
  </div>
</body>
</html>
